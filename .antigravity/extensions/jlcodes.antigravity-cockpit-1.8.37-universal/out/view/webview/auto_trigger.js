"use strict";(()=>{(function(){"use strict";let I=window.__vscodeApi||(window.__vscodeApi=acquireVsCodeApi()),be=window.__autoTriggerI18n||{},i=e=>be[e]||e,$=window.AntigravityAuthUI?window.__authUi||(window.__authUi=new window.AntigravityAuthUI(I)):null,re=["06:00","07:00","08:00","09:00","10:00","11:00","12:00","14:00","16:00","18:00","20:00","22:00"],x=null,h=[],ke=new Set(["chat_20706","chat_23310","gemini-2.5-flash-thinking","gemini-2.5-pro"]),Ie=new Set(["Gemini 2.5 Flash (Thinking)","Gemini 2.5 Pro","chat_20706","chat_23310"]),E=[],p=[],L=[],y="",_=!1,J=!0,T=[],g=[],H=!1,f="scheduled",w="daily",q=["08:00"],B=[1,2,3,4,5],N=["08:00"],W=4,z="07:00",F="22:00",j=0,we=[...re],Be=[...re],A=!1,P="09:00",V="18:00",b=["07:00"],X=0;function U(e,t){let n=typeof e=="number"?e:Number.parseInt(String(e),10);return!Number.isFinite(n)||n<0?t:Math.floor(n)}function Y(e){if(typeof e=="boolean")if(_=e,$)$.updateState(x?.authorization,e,J);else{let t=document.getElementById("at-antigravityTools-sync-checkbox");t&&(t.checked=e)}}function ue(e){typeof e=="boolean"&&(J=e,$&&$.updateState(x?.authorization,_,e))}function me(){let e=document.getElementById("at-antigravityTools-sync-checkbox"),t=document.getElementById("at-antigravityTools-import-btn");e?.addEventListener("change",n=>{let a=n.target;if(!(a instanceof HTMLInputElement))return;let o=a.checked;_=o,I.postMessage({command:"antigravityToolsSync.toggle",enabled:o})}),t?.addEventListener("click",()=>{I.postMessage({command:"antigravityToolsSync.import"})})}function Z(){I.postMessage({command:"autoTrigger.getState"}),Le()}function Le(){document.getElementById("at-auth-btn")?.addEventListener("click",()=>{I.postMessage({command:"autoTrigger.authorize"})}),document.getElementById("at-config-btn")?.addEventListener("click",Se),document.getElementById("at-config-close")?.addEventListener("click",ee),document.getElementById("at-config-cancel")?.addEventListener("click",ee),document.getElementById("at-config-save")?.addEventListener("click",He),document.getElementById("at-test-btn")?.addEventListener("click",Me),document.getElementById("at-test-close")?.addEventListener("click",te),document.getElementById("at-test-cancel")?.addEventListener("click",te),document.getElementById("at-test-run")?.addEventListener("click",Oe),document.getElementById("at-history-btn")?.addEventListener("click",Ae),document.getElementById("at-history-close")?.addEventListener("click",ge),document.getElementById("at-revoke-close")?.addEventListener("click",ne),document.getElementById("at-revoke-cancel")?.addEventListener("click",ne),document.getElementById("at-revoke-confirm")?.addEventListener("click",Ce),document.getElementById("at-history-clear")?.addEventListener("click",()=>{I.postMessage({command:"autoTrigger.clearHistory"}),ge()}),document.getElementById("at-mode-select")?.addEventListener("change",e=>{w=e.target.value,ie(),G(),k()}),document.getElementById("at-enable-schedule")?.addEventListener("change",e=>{H=e.target.checked,fe()}),document.getElementById("at-trigger-mode-list")?.addEventListener("click",e=>{let t=e.target.closest(".at-segment-btn");if(!t)return;let n=t.dataset.mode;n&&(f=n,oe(),ye(),k())}),document.getElementById("at-daily-times")?.addEventListener("click",e=>{if(e.target.classList.contains("at-chip")){let t=e.target.dataset.time;he(t,"daily"),k()}}),ce("at-daily-custom-time","at-daily-add-time","daily"),document.getElementById("at-weekly-times")?.addEventListener("click",e=>{if(e.target.classList.contains("at-chip")){let t=e.target.dataset.time;he(t,"weekly"),k()}}),ce("at-weekly-custom-time","at-weekly-add-time","weekly"),document.getElementById("at-weekly-days")?.addEventListener("click",e=>{if(e.target.classList.contains("at-chip")){let t=parseInt(e.target.dataset.day,10);je(t),k()}}),document.querySelectorAll(".at-quick-btn").forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.preset;t==="workdays"?B=[1,2,3,4,5]:t==="weekend"?B=[0,6]:t==="all"&&(B=[0,1,2,3,4,5,6]),se(),k()})}),document.getElementById("at-interval-hours")?.addEventListener("change",e=>{W=parseInt(e.target.value,10)||4,k()}),document.getElementById("at-interval-start")?.addEventListener("change",e=>{z=e.target.value,k()}),document.getElementById("at-interval-end")?.addEventListener("change",e=>{F=e.target.value,k()}),document.getElementById("at-crontab-validate")?.addEventListener("click",()=>{let e=document.getElementById("at-crontab-input"),t=document.getElementById("at-crontab-result");e&&t&&(e.value.trim()?(t.className="at-crontab-result",t.style.color="var(--vscode-charts-green)",t.textContent=i("autoTrigger.validateOnSave")):(t.className="at-crontab-result",t.style.color="var(--vscode-errorForeground)",t.textContent=i("autoTrigger.crontabEmpty")))}),document.getElementById("at-crontab-input")?.addEventListener("input",()=>{f==="crontab"&&k()}),document.getElementById("at-time-window-enabled")?.addEventListener("change",e=>{A=e.target.checked,le()}),document.getElementById("at-time-window-start")?.addEventListener("change",e=>{P=e.target.value}),document.getElementById("at-time-window-end")?.addEventListener("change",e=>{V=e.target.value}),document.getElementById("at-fallback-times")?.addEventListener("click",e=>{if(e.target.classList.contains("at-chip")){let t=e.target.dataset.time;Fe(t)}}),ce("at-fallback-custom-time","at-fallback-add-time","fallback"),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("click",t=>{t.target===e&&e.id!=="rename-modal"&&e.classList.add("hidden")})})}function Se(){De(),Pe(),ie(),G(),se(),ye(),fe(),k(),document.getElementById("at-config-modal")?.classList.remove("hidden")}function ee(){document.getElementById("at-config-modal")?.classList.add("hidden")}function Me(){let e=h.map(a=>a.id),t=E.filter(a=>e.includes(a));t.length>0?T=[...t]:h.length>0?T=[h[0].id]:T=[],g.length===0&&y&&(g=[y]);let n=document.getElementById("at-test-max-output-tokens");if(n){let a=x?.schedule?.maxOutputTokens;X=U(a,j),n.value=String(X)}Ve(),Ue(),document.getElementById("at-test-modal")?.classList.remove("hidden")}function te(){document.getElementById("at-test-modal")?.classList.add("hidden")}function Ae(){Ge(),document.getElementById("at-history-modal")?.classList.remove("hidden")}function ge(){document.getElementById("at-history-modal")?.classList.add("hidden")}let O="",C="";function $e(){let e=document.getElementById("at-revoke-modal");if(!e)return;let t=e.querySelector("p");t&&!C&&(C=t.textContent||""),O||t&&(t.textContent=C||i("autoTrigger.revokeConfirm")),e.classList.remove("hidden")}function xe(e){O=String(e||"");let t=document.getElementById("at-revoke-modal");if(t){let n=t.querySelector("p");n&&!C&&(C=n.textContent||"");let a=i("autoTrigger.confirmRemove")||i("autoTrigger.revokeConfirm");n&&(n.textContent=a.replace("{email}",O))}$e()}function ne(){let e=document.getElementById("at-revoke-modal");if(e){let t=e.querySelector("p");t&&C&&(t.textContent=C),e.classList.add("hidden")}O=""}function Ce(){O?I.postMessage({command:"autoTrigger.removeAccount",email:O}):I.postMessage({command:"autoTrigger.revoke"}),ne()}function De(){if(!x?.schedule)return;let e=x.schedule;H=e.enabled||!1,w=e.repeatMode||"daily",q=e.dailyTimes||["08:00"],B=e.weeklyDays||[1,2,3,4,5],N=e.weeklyTimes||["08:00"],W=e.intervalHours||4,z=e.intervalStartTime||"07:00",F=e.intervalEndTime||"22:00",E=e.selectedModels||["gemini-3-flash"],Array.isArray(e.selectedAccounts)&&(p=e.selectedAccounts.slice()),p.length===0&&y&&(p=[y]),document.getElementById("at-enable-schedule").checked=H,document.getElementById("at-mode-select").value=w,document.getElementById("at-interval-hours").value=W,document.getElementById("at-interval-start").value=z,e.wakeOnReset?f="quota_reset":e.crontab?f="crontab":f="scheduled",oe();let t=document.getElementById("at-custom-prompt");t&&(t.value=e.customPrompt||""),j=U(e.maxOutputTokens,0);let n=document.getElementById("at-max-output-tokens");n&&(n.value=String(j));let a=document.getElementById("at-crontab-input");a&&(a.value=e.crontab||""),document.getElementById("at-interval-end").value=F,A=e.timeWindowEnabled||!1,P=e.timeWindowStart||"09:00",V=e.timeWindowEnd||"18:00",b=e.fallbackTimes||["07:00"];let o=document.getElementById("at-time-window-enabled");o&&(o.checked=A);let c=document.getElementById("at-time-window-start");c&&(c.value=P);let l=document.getElementById("at-time-window-end");l&&(l.value=V),de(),le(),pe()}function He(){let e=f==="quota_reset",t=f==="crontab",n=document.getElementById("at-crontab-input")?.value.trim()||"";if(H&&t&&!n){let c=document.getElementById("at-crontab-result");c&&(c.className="at-crontab-result",c.style.color="var(--vscode-errorForeground)",c.textContent=i("autoTrigger.crontabEmpty"));return}let a=U(document.getElementById("at-max-output-tokens")?.value,0);j=a;let o={enabled:H,repeatMode:w,dailyTimes:q,weeklyDays:B,weeklyTimes:N,intervalHours:W,intervalStartTime:z,intervalEndTime:F,selectedModels:E.length>0?E:["gemini-3-flash"],selectedAccounts:p.length>0?p:y?[y]:[],crontab:t&&n||void 0,wakeOnReset:e,customPrompt:document.getElementById("at-custom-prompt")?.value.trim()||void 0,maxOutputTokens:a,timeWindowEnabled:e?A:!1,timeWindowStart:e&&A?P:void 0,timeWindowEnd:e&&A?V:void 0,fallbackTimes:e&&A&&b.length>0?b:void 0};I.postMessage({command:"autoTrigger.saveSchedule",schedule:o}),ee()}let ae=!1;function qe(){let e=document.getElementById("at-test-models");return e?Array.from(e.querySelectorAll(".at-model-item.selected")).map(t=>t.dataset.model).filter(Boolean):[]}function Ne(){let e=document.getElementById("at-test-accounts");return e?Array.from(e.querySelectorAll(".at-model-item.selected")).map(t=>t.dataset.email).filter(Boolean):[]}function Oe(){if(ae)return;let e=qe();e.length>0&&(T=e),T.length===0&&(T=[h.length>0?h[0].id:"gemini-3-flash"]);let t=Ne();t.length>0&&(g=t),g.length===0&&y&&(g=[y]);let n=document.getElementById("at-test-custom-prompt")?.value.trim()||void 0,a=U(document.getElementById("at-test-max-output-tokens")?.value,j);X=a,ae=!0;let o=document.getElementById("at-test-run");o&&(o.disabled=!0,o.innerHTML=`<span class="at-spinner"></span> ${i("autoTrigger.testing")}`),te(),Re(),I.postMessage({command:"autoTrigger.test",models:[...T],customPrompt:n,accounts:[...g],maxOutputTokens:a})}function Re(){let e=document.getElementById("at-status-card");if(!e)return;let t=document.getElementById("at-testing-banner");t||(t=document.createElement("div"),t.id="at-testing-banner",t.className="at-testing-banner",e.insertBefore(t,e.firstChild)),t.innerHTML=`<span class="at-spinner"></span> ${i("autoTrigger.testingPleaseWait")}`,t.classList.remove("hidden")}function _e(){let e=document.getElementById("at-testing-banner");e&&e.classList.add("hidden"),ae=!1;let t=document.getElementById("at-test-run");t&&(t.disabled=!1,t.innerHTML=`\u{1F680} ${i("autoTrigger.runTest")}`)}function fe(){let e=document.getElementById("at-wakeup-config-body");e&&e.classList.toggle("at-disabled",!H)}function ye(){let e=document.getElementById("at-schedule-config-section"),t=document.getElementById("at-crontab-config-section"),n=document.getElementById("at-quota-reset-config-section"),a=document.getElementById("at-custom-prompt-section");e&&e.classList.toggle("hidden",f!=="scheduled"),t&&t.classList.toggle("hidden",f!=="crontab"),n&&n.classList.toggle("hidden",f!=="quota_reset"),a&&a.classList.remove("hidden"),oe(),f==="scheduled"&&ie(),f==="quota_reset"&&le()}function oe(){let e=document.getElementById("at-trigger-mode-list");e&&e.querySelectorAll(".at-segment-btn").forEach(t=>{let n=t.dataset.mode;t.classList.toggle("selected",n===f),t.setAttribute("aria-pressed",n===f?"true":"false")})}function ie(){document.getElementById("at-config-daily")?.classList.toggle("hidden",w!=="daily"),document.getElementById("at-config-weekly")?.classList.toggle("hidden",w!=="weekly"),document.getElementById("at-config-interval")?.classList.toggle("hidden",w!=="interval")}function G(){let e=w==="daily"?q:N,t=w==="daily"?"at-daily-times":"at-weekly-times",n=w==="daily"?we:Be,a=document.getElementById(t);a&&(a.querySelectorAll('.at-chip[data-custom="true"]').forEach(o=>{e.includes(o.dataset.time)||o.remove()}),e.forEach(o=>{if(!n.includes(o)&&!a.querySelector(`.at-chip[data-time="${o}"]`)){let c=document.createElement("div");c.className="at-chip at-chip-custom",c.dataset.time=o,c.dataset.custom="true",c.textContent=o,a.appendChild(c)}}),a.querySelectorAll(".at-chip").forEach(o=>{o.classList.toggle("selected",e.includes(o.dataset.time))}))}function se(){document.querySelectorAll("#at-weekly-days .at-chip").forEach(e=>{let t=parseInt(e.dataset.day,10);e.classList.toggle("selected",B.includes(t))})}function he(e,t){let n=t==="daily"?q:N,a=n.indexOf(e);a>=0?n.length>1&&n.splice(a,1):n.push(e),n.sort(),G()}function ce(e,t,n){let a=document.getElementById(e),o=document.getElementById(t);if(!a||!o)return;let c=()=>{let l=We(a.value);l&&(ze(l,n),a.value="",k())};o.addEventListener("click",c),a.addEventListener("keydown",l=>{l.key==="Enter"&&(l.preventDefault(),c())})}function We(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/^(\d{1,2}):(\d{2})$/);if(!n)return null;let a=parseInt(n[1],10),o=parseInt(n[2],10);return Number.isNaN(a)||Number.isNaN(o)||a<0||a>23||o<0||o>59?null:`${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`}function ze(e,t){let n;if(t==="daily")n=q;else if(t==="weekly")n=N;else if(t==="fallback")n=b;else return;n.includes(e)||(n.push(e),n.sort()),t==="fallback"?de():G()}function le(){let e=document.getElementById("at-time-window-config");e&&e.classList.toggle("hidden",!A)}function Fe(e){let t=b.indexOf(e);t>=0?b.length>1&&b.splice(t,1):b.push(e),b.sort(),de()}function de(){let e=document.getElementById("at-fallback-times");if(!e)return;let t=["06:00","07:00","08:00"];e.querySelectorAll('.at-chip[data-custom="true"]').forEach(n=>{b.includes(n.dataset.time)||n.remove()}),b.forEach(n=>{if(!t.includes(n)&&!e.querySelector(`.at-chip[data-time="${n}"]`)){let a=document.createElement("div");a.className="at-chip at-chip-custom",a.dataset.time=n,a.dataset.custom="true",a.textContent=n,e.appendChild(a)}}),e.querySelectorAll(".at-chip").forEach(n=>{n.classList.toggle("selected",b.includes(n.dataset.time))})}function je(e){let t=B.indexOf(e);t>=0?B.length>1&&B.splice(t,1):B.push(e),se()}function Pe(){let e=document.getElementById("at-config-models");if(e){if(h.length===0){e.innerHTML=`<div class="at-no-data">${i("autoTrigger.noModels")}</div>`;return}e.innerHTML=h.map(t=>`<div class="at-model-item ${E.includes(t.id)?"selected":""}" data-model="${t.id}">${t.displayName}</div>`).join(""),e.querySelectorAll(".at-model-item").forEach(t=>{t.addEventListener("click",()=>{let n=t.dataset.model,a=E.indexOf(n);a>=0?E.length>1&&(E.splice(a,1),t.classList.remove("selected")):(E.push(n),t.classList.add("selected"))})})}}function pe(){let e=document.getElementById("at-config-accounts");if(e){if(!L||L.length===0){e.innerHTML=`<div class="at-no-data">${i("autoTrigger.noAccounts")}</div>`;return}e.innerHTML=L.map(t=>`<div class="at-model-item ${p.includes(t)?"selected":""}" data-email="${t}">${t}</div>`).join(""),e.querySelectorAll(".at-model-item").forEach(t=>{t.addEventListener("click",()=>{let n=t.dataset.email,a=p.indexOf(n);a>=0?p.length>1&&(p.splice(a,1),t.classList.remove("selected")):(p.push(n),t.classList.add("selected"))})})}}function Ve(){let e=document.getElementById("at-test-models");if(e){if(h.length===0){e.innerHTML=`<div class="at-no-data">${i("autoTrigger.noModels")}</div>`;return}e.innerHTML=h.map(t=>`<div class="at-model-item ${T.includes(t.id)?"selected":""}" data-model="${t.id}">${t.displayName}</div>`).join(""),e.querySelectorAll(".at-model-item").forEach(t=>{t.addEventListener("click",()=>{let n=t.dataset.model,a=T.indexOf(n);a>=0?T.length>1&&(T.splice(a,1),t.classList.remove("selected")):(T.push(n),t.classList.add("selected"))})})}}function Ue(){let e=document.getElementById("at-test-accounts");if(e){if(!L||L.length===0){e.innerHTML=`<div class="at-no-data">${i("autoTrigger.noAccounts")}</div>`;return}g.length===0&&y&&(g=[y]),e.innerHTML=L.map(t=>`<div class="at-model-item ${g.includes(t)?"selected":""}" data-email="${t}">${t}</div>`).join(""),e.querySelectorAll(".at-model-item").forEach(t=>{t.addEventListener("click",()=>{let n=t.dataset.email,a=g.indexOf(n);a>=0?g.length>1&&(g.splice(a,1),t.classList.remove("selected")):(g.push(n),t.classList.add("selected"))})})}}function Ge(){let e=document.getElementById("at-history-list");if(!e)return;let t=x?.recentTriggers||[];if(t.length===0){e.innerHTML=`<div class="at-no-data">${i("autoTrigger.noHistory")}</div>`;return}e.innerHTML=t.map(n=>{let o=new Date(n.timestamp).toLocaleString(),c=n.success?"\u2705":"\u274C",l=n.success?i("autoTrigger.success"):i("autoTrigger.failed"),r=n.accountEmail?`<span class="at-history-account" title="${K(n.accountEmail)}">${K(n.accountEmail)}</span>`:"",s="";n.prompt&&(s+=`<div class="at-history-prompt">${K(n.prompt)}</div>`),n.message&&(s+=`<div class="at-history-response">${Ke(n.message)}</div>`),s||(s=`<div class="at-history-message">${l}</div>`);let d=i("autoTrigger.typeManual"),u="at-history-type-manual";n.triggerType==="auto"&&(u="at-history-type-auto",n.triggerSource==="scheduled"?d=i("autoTrigger.typeAutoScheduled"):n.triggerSource==="crontab"?d=i("autoTrigger.typeAutoCrontab"):n.triggerSource==="quota_reset"?d=i("autoTrigger.typeAutoQuotaReset"):d=i("autoTrigger.typeAuto"));let v=`<span class="at-history-type-badge ${u}">${d}</span>`;return`
                <div class="at-history-item">
                    <span class="at-history-icon">${c}</span>
                    <div class="at-history-info">
                        <div class="at-history-time">${o}${v}${r}</div>
                        ${s}
                    </div>
                    ${n.duration?`<span class="at-history-duration">${n.duration}ms</span>`:""}
                </div>
            `}).join("")}function K(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ke(e){if(!e)return"";let t=K(e);return t=t.replace(/\[\[([^\]]+)\]\]/g,'<span class="at-model-name">$1</span>'),t=t.replace(/\n\n/g,"<br><br>"),t}function k(){if(f==="quota_reset")return;let e=f==="crontab"?"at-next-runs-crontab":"at-next-runs-scheduled",t=document.getElementById(e);if(!t)return;if(f==="crontab"){let c=document.getElementById("at-crontab-input")?.value?.trim();if(!c){t.innerHTML=`<li>${i("autoTrigger.crontabEmpty")}</li>`;return}let l=ve(c,5);if(l.length===0){t.innerHTML='<li style="color: var(--vscode-errorForeground)">\u65E0\u6548\u7684 Crontab \u8868\u8FBE\u5F0F</li>';return}t.innerHTML=l.map((r,s)=>`<li>${s+1}. ${Q(r)}</li>`).join("");return}let a=Qe({repeatMode:w,dailyTimes:q,weeklyDays:B,weeklyTimes:N,intervalHours:W,intervalStartTime:z,intervalEndTime:F},5);if(a.length===0){t.innerHTML=`<li>${i("autoTrigger.selectTimeHint")}</li>`;return}t.innerHTML=a.map((o,c)=>{let l=new Date(o);return`<li>${c+1}. ${Q(l)}</li>`}).join("")}function ve(e,t){try{let n=e.split(/\s+/);if(n.length<5)return[];let[a,o,c,l,r]=n,s=[],d=new Date,u=(m,R)=>{if(m==="*")return Array.from({length:R+1},(S,M)=>M);if(m.includes(","))return m.split(",").map(Number);if(m.includes("-")){let[S,M]=m.split("-").map(Number);return Array.from({length:M-S+1},(Te,et)=>S+et)}if(m.includes("/")){let[,S]=m.split("/");return Array.from({length:Math.ceil(R/Number(S))},(M,Te)=>Te*Number(S))}return[Number(m)]},v=u(a,59),D=u(o,23);for(let m=0;m<7&&s.length<t;m++)for(let R of D){for(let S of v){let M=new Date(d);if(M.setDate(M.getDate()+m),M.setHours(R,S,0,0),M>d&&(s.push(M),s.length>=t))break}if(s.length>=t)break}return s}catch{return[]}}function Qe(e,t){let n=new Date,a=[];if(e.repeatMode==="daily"&&e.dailyTimes?.length)for(let o=0;o<7&&a.length<t;o++)for(let c of e.dailyTimes.sort()){let[l,r]=c.split(":").map(Number),s=new Date(n);if(s.setDate(s.getDate()+o),s.setHours(l,r,0,0),s>n&&(a.push(s.toISOString()),a.length>=t))break}else if(e.repeatMode==="weekly"&&e.weeklyDays?.length&&e.weeklyTimes?.length)for(let o=0;o<14&&a.length<t;o++){let c=new Date(n);c.setDate(c.getDate()+o);let l=c.getDay();if(e.weeklyDays.includes(l))for(let r of e.weeklyTimes.sort()){let[s,d]=r.split(":").map(Number);if(c.setHours(s,d,0,0),c>n&&(a.push(c.toISOString()),a.length>=t))break}}else if(e.repeatMode==="interval"){let[o,c]=(e.intervalStartTime||"07:00").split(":").map(Number),l=e.intervalEndTime?parseInt(e.intervalEndTime.split(":")[0],10):22,r=e.intervalHours||4;for(let s=0;s<7&&a.length<t;s++)for(let d=o;d<=l;d+=r){let u=new Date(n);if(u.setDate(u.getDate()+s),u.setHours(d,c,0,0),u>n&&(a.push(u.toISOString()),a.length>=t))break}}return a.slice(0,t)}function Q(e){let t=new Date,n=new Date(t);n.setDate(n.getDate()+1);let a=e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"});return e.toDateString()===t.toDateString()?`${i("time.today")} ${a}`:e.toDateString()===n.toDateString()?`${i("time.tomorrow")} ${a}`:`${i(["time.sunday","time.monday","time.tuesday","time.wednesday","time.thursday","time.friday","time.saturday"][e.getDay()])} ${a}`}function Ee(e){x=e,h=Je(e.availableModels||[]),e.schedule?.selectedModels&&(E=e.schedule.selectedModels),L=(e.authorization?.accounts||[]).map(n=>n.email).filter(Boolean),y=e.authorization?.activeAccount||e.authorization?.email||L[0]||"",Array.isArray(e.schedule?.selectedAccounts)?p=e.schedule.selectedAccounts.filter(n=>L.includes(n)):y&&(p=[y]),Array.isArray(g)&&g.length>0?g=g.filter(n=>L.includes(n)):y&&(g=[y]),Array.isArray(e.schedule?.selectedModels)?E=e.schedule.selectedModels.filter(a=>h.some(o=>o.id===a)):h.length>0&&(E=[h[0].id]),_e(),Xe(e.authorization),Ye(e),Ze(e.recentTriggers?.length||0),pe()}function Je(e){if(!Array.isArray(e)||e.length===0)return[];let t=[];for(let n of e){let a=n.displayName||n.id,o=ke.has(n.id),c=Ie.has(a);if(o||c){c&&!o&&console.info("[AutoTrigger] Hidden model by name, please confirm ID:",{id:n.id,displayName:n.displayName});continue}t.push(n)}return t}function Xe(e){let t=document.getElementById("at-auth-row"),n=document.getElementById("at-status-card"),a=document.getElementById("at-status-grid"),o=document.getElementById("at-actions");if(!t)return;let c=e?.accounts||[],l=c.length>0,r=l||e?.isAuthorized;if($)$.updateState(e,_,J),$.renderAuthRow(t,{showSyncToggleInline:!1});else{let d=e?.activeAccount||e?.email||(l?c[0].email:""),u=`
                <label class="antigravityTools-sync-toggle">
                    <input type="checkbox" id="at-antigravityTools-sync-checkbox" ${_?"checked":""}>
                    <span>${i("autoTrigger.antigravityToolsSync")}</span>
                </label>
            `,v=`<button id="at-antigravityTools-import-btn" class="at-btn at-btn-secondary">${i("autoTrigger.importFromAntigravityTools")}</button>`;if(r){let D=Math.max(c.length-1,0),m=D>0?`<span class="account-count-badge" title="${i("autoTrigger.manageAccounts")}">+${D}</span>`:"",R=c.length>0?`<button id="at-account-manage-btn" class="quota-account-manage-btn" title="${i("autoTrigger.manageAccounts")}">${i("autoTrigger.manageAccounts")}</button>`:"";t.innerHTML=`
                    <div class="quota-auth-info quota-auth-info-clickable" title="${i("autoTrigger.manageAccounts")}">
                        <span class="at-auth-icon">\u2705</span>
                        <span class="at-auth-text">${i("autoTrigger.authorized")}</span>
                        <span class="quota-auth-email">${d}</span>
                        ${m}
                        ${R}
                    </div>
                    <div class="quota-auth-actions at-auth-actions">
                        ${u}
                        ${v}
                    </div>
                `,t.querySelector(".quota-auth-info")?.addEventListener("click",()=>{typeof window.openAccountManageModal=="function"&&window.openAccountManageModal()}),document.getElementById("at-account-manage-btn")?.addEventListener("click",S=>{S.stopPropagation(),typeof window.openAccountManageModal=="function"&&window.openAccountManageModal()}),me()}else t.innerHTML=`
                    <div class="quota-auth-info">
                        <span class="at-auth-icon">\u26A0\uFE0F</span>
                        <span class="at-auth-text">${i("autoTrigger.unauthorized")}</span>
                    </div>
                    <div class="quota-auth-actions at-auth-actions">
                        ${u}
                        ${v}
                        <button id="at-auth-btn" class="at-btn at-btn-primary">${i("autoTrigger.authorizeBtn")}</button>
                    </div>
                `,document.getElementById("at-auth-btn")?.addEventListener("click",()=>{I.postMessage({command:"autoTrigger.authorize"})}),me()}r?(n?.classList.remove("hidden"),a?.classList.remove("hidden"),o?.classList.remove("hidden")):(n?.classList.add("hidden"),a?.classList.add("hidden"),o?.classList.add("hidden"))}function Ye(e){let t=e.schedule||{},n=document.getElementById("at-status-value");n&&(n.textContent=t.enabled?i("autoTrigger.enabled"):i("autoTrigger.disabled"),n.style.color=t.enabled?"var(--vscode-charts-green)":"");let a=document.getElementById("at-tab-status-dot");a&&(e.authorization?.isAuthorized&&t.enabled?a.classList.remove("hidden"):a.classList.add("hidden"));let o=document.getElementById("at-mode-value");if(o){let s="--";if(t.wakeOnReset)s=`\u{1F504} ${i("autoTrigger.modeQuotaReset")}`;else if(t.crontab)s=`Crontab: ${t.crontab}`;else if(t.repeatMode==="daily"&&t.dailyTimes?.length){let d=t.dailyTimes.slice(0,5).join(", "),u=t.dailyTimes.length>5?"...":"";s=`${i("autoTrigger.daily")} ${d}${u}`}else if(t.repeatMode==="weekly"&&t.weeklyDays?.length){let d=[i("time.sunday"),i("time.monday"),i("time.tuesday"),i("time.wednesday"),i("time.thursday"),i("time.friday"),i("time.saturday")],u=t.weeklyDays.map(m=>d[m]||m).join(", "),v=t.weeklyTimes?.slice(0,5).join(", ")||"",D=t.weeklyTimes?.length>5?"...":"";s=`${i("autoTrigger.weekly")} ${u}
${v}${D}`}else t.repeatMode==="interval"&&(s=`${i("autoTrigger.interval")} ${t.intervalHours||4}h`);o.textContent=s}let c=document.getElementById("at-models-value");if(c){let s=t.selectedModels||["gemini-3-flash"],d=v=>h.find(m=>m.id===v)?.displayName||v,u=s.map(v=>d(v));c.textContent=u.join(", ")}let l=document.getElementById("at-accounts-value");if(l){let s=p;s.length===0?l.textContent="--":s.length===1?l.textContent=s[0]:(l.textContent=`${s[0]} (+${s.length-1})`,l.title=s.join(`
`))}let r=document.getElementById("at-next-value");if(r)if(t.wakeOnReset)r.textContent="--";else if(t.enabled&&e.nextTriggerTime){let s=new Date(e.nextTriggerTime);r.textContent=Q(s)}else if(t.enabled&&t.crontab){let s=ve(t.crontab,1);s.length>0?r.textContent=Q(s[0]):r.textContent="--"}else r.textContent="--"}function Ze(e){let t=document.getElementById("at-history-count");t&&(t.textContent=`(${e})`)}window.addEventListener("message",e=>{let t=e.data;switch(t.type){case"autoTriggerState":Ee(t.data);break;case"telemetry_update":t.config?.antigravityToolsSyncEnabled!==void 0&&Y(!!t.config.antigravityToolsSyncEnabled),t.config?.antigravityToolsAutoSwitchEnabled!==void 0&&ue(!!t.config.antigravityToolsAutoSwitchEnabled);break;case"antigravityToolsSyncStatus":t.data?.enabled!==void 0&&Y(!!t.data.enabled),t.data?.autoSyncEnabled!==void 0&&Y(!!t.data.autoSyncEnabled),t.data?.autoSwitchEnabled!==void 0&&ue(!!t.data.autoSwitchEnabled);break}}),window.AutoTriggerTab={init:Z,updateState:Ee},window.openRevokeModalForEmail=xe,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Z):Z()})();})();
