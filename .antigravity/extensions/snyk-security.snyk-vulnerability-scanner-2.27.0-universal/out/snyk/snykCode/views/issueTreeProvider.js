"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.IssueTreeProvider = void 0;
const types_1 = require("../../common/commands/types");
const commands_1 = require("../../common/constants/commands");
const issueTreeProvider_1 = require("../../common/views/issueTreeProvider");
const analysis_1 = require("../messages/analysis");
const analysisMessages_1 = require("../../common/messages/analysisMessages");
const issueUtils_1 = require("../utils/issueUtils");
const featureFlags_1 = require("../../common/constants/featureFlags");
const general_1 = require("../../common/constants/general");
const treeNode_1 = require("../../common/views/treeNode");
class IssueTreeProvider extends issueTreeProvider_1.ProductIssueTreeProvider {
    constructor(logger, contextService, codeService, configuration, languages, isSecurityType, folderConfigs) {
        super(logger, contextService, codeService, configuration, languages, folderConfigs);
        this.logger = logger;
        this.contextService = contextService;
        this.codeService = codeService;
        this.configuration = configuration;
        this.languages = languages;
        this.isSecurityType = isSecurityType;
        this.folderConfigs = folderConfigs;
        this.getRunTestMessage = () => analysis_1.messages.runTest;
    }
    shouldShowTree() {
        return this.contextService.shouldShowCodeAnalysis;
    }
    filterIssues(issues) {
        return issues.filter(i => i.additionalData.isSecurityType == this.isSecurityType);
    }
    // The title in the tree is taken from the title for vulnerabilities and from the message for quality rules
    getIssueTitle(issue) {
        const fixIcon = issue.additionalData.hasAIFix ? '⚡️' : '';
        const issueTitle = issue.additionalData.isSecurityType
            ? issue.title.split(':')[0]
            : issue.additionalData.message.split('.')[0];
        let prefixIgnored = '';
        if (issue.isIgnored) {
            prefixIgnored = '[ Ignored ] ';
        }
        return fixIcon + prefixIgnored + issueTitle;
    }
    getIssueRange(issue) {
        return issueUtils_1.IssueUtils.createVsCodeRange(issue.additionalData, this.languages);
    }
    getOpenIssueCommand(issue, folderPath, filePath, _filteredIssues) {
        return {
            command: commands_1.SNYK_OPEN_ISSUE_COMMAND,
            title: '',
            arguments: [
                {
                    issueType: types_1.OpenCommandIssueType.CodeIssue,
                    issue: {
                        id: issue.id,
                        folderPath,
                        filePath,
                        range: this.getIssueRange(issue),
                    },
                },
            ],
        };
    }
    isFixableIssue(issue) {
        return issue.additionalData.hasAIFix;
    }
    getFixableIssuesText(fixableIssueCount) {
        const isIgnoresEnabled = this.configuration.getFeatureFlag(featureFlags_1.FEATURE_FLAGS.consistentIgnores);
        const showingOpen = this.configuration.issueViewOptions.openIssues;
        if (isIgnoresEnabled && !showingOpen) {
            return null;
        }
        return fixableIssueCount > 0
            ? `⚡️ ${fixableIssueCount}${isIgnoresEnabled ? ' open' : ''} issue${fixableIssueCount === 1 ? ' is' : 's are'}` +
                ' fixable by Snyk Agent Fix.'
            : analysisMessages_1.messages.noFixableIssues;
    }
    getNoIssueViewOptionsSelectedTreeNode() {
        const isIgnoresEnabled = this.configuration.getFeatureFlag(featureFlags_1.FEATURE_FLAGS.consistentIgnores);
        if (!isIgnoresEnabled) {
            return null;
        }
        const showingOpen = this.configuration.issueViewOptions.openIssues;
        const showingIgnored = this.configuration.issueViewOptions.ignoredIssues;
        if (!showingOpen && !showingIgnored) {
            return new treeNode_1.TreeNode({
                text: analysisMessages_1.messages.allIssueViewOptionsDisabled,
                command: {
                    command: commands_1.VSCODE_GO_TO_SETTINGS_COMMAND,
                    title: '',
                    arguments: [`@ext:${general_1.SNYK_PUBLISHER}.${general_1.SNYK_NAME_EXTENSION} snyk.issueViewOptions`],
                },
            });
        }
        if (!showingOpen) {
            return new treeNode_1.TreeNode({
                text: analysisMessages_1.messages.openIssueViewOptionDisabled,
                command: {
                    command: commands_1.VSCODE_GO_TO_SETTINGS_COMMAND,
                    title: '',
                    arguments: [`@ext:${general_1.SNYK_PUBLISHER}.${general_1.SNYK_NAME_EXTENSION} snyk.issueViewOptions`],
                },
            });
        }
        if (!showingIgnored) {
            return new treeNode_1.TreeNode({
                text: analysisMessages_1.messages.ignoredIssueViewOptionDisabled,
                command: {
                    command: commands_1.VSCODE_GO_TO_SETTINGS_COMMAND,
                    title: '',
                    arguments: [`@ext:${general_1.SNYK_PUBLISHER}.${general_1.SNYK_NAME_EXTENSION} snyk.issueViewOptions`],
                },
            });
        }
        return null;
    }
    getIssueFoundText(totalIssueCount, openIssueCount, ignoredIssueCount) {
        const isIgnoresEnabled = this.configuration.getFeatureFlag(featureFlags_1.FEATURE_FLAGS.consistentIgnores);
        if (!isIgnoresEnabled) {
            return super.getIssueFoundText(totalIssueCount, openIssueCount, ignoredIssueCount);
        }
        const showingOpen = this.configuration.issueViewOptions.openIssues;
        const showingIgnored = this.configuration.issueViewOptions.ignoredIssues;
        const openIssuesText = `${openIssueCount} open issue${openIssueCount === 1 ? '' : 's'}`;
        const ignoredIssuesText = `${ignoredIssueCount} ignored issue${ignoredIssueCount === 1 ? '' : 's'}`;
        if (showingOpen && showingIgnored) {
            if (totalIssueCount === 0) {
                return analysisMessages_1.messages.congratsNoIssuesFound;
            }
            else {
                if (ignoredIssueCount === 0) {
                    return `✋ ${openIssuesText}`;
                }
                return `✋ ${openIssuesText} & ${ignoredIssuesText}`;
            }
        }
        if (showingOpen) {
            if (openIssueCount === 0) {
                return analysisMessages_1.messages.congratsNoOpenIssuesFound;
            }
            else {
                return `✋ ${openIssuesText}`;
            }
        }
        if (showingIgnored) {
            if (ignoredIssueCount === 0) {
                return analysisMessages_1.messages.noIgnoredIssues;
            }
            else {
                return `✋ ${ignoredIssuesText}, open issues are disabled`;
            }
        }
        return analysisMessages_1.messages.openAndIgnoredIssuesAreDisabled;
    }
}
exports.IssueTreeProvider = IssueTreeProvider;
//# sourceMappingURL=issueTreeProvider.js.map