"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LanguageClientMiddleware = void 0;
const tsUtil_1 = require("../tsUtil");
const types_1 = require("../vscode/types");
const settings_1 = require("./settings");
const types_2 = require("./types");
class LanguageClientMiddleware {
    constructor(logger, configuration, user, showIssueDetailTopic$) {
        this.logger = logger;
        this.configuration = configuration;
        this.user = user;
        this.showIssueDetailTopic$ = showIssueDetailTopic$;
        this.workspace = {
            configuration: async (params, token, next) => {
                let settings = next(params, token);
                if ((0, tsUtil_1.isThenable)(settings)) {
                    settings = await settings;
                }
                if (settings instanceof Error) {
                    return settings;
                }
                if (!settings.length) {
                    return [];
                }
                const serverSettings = await settings_1.LanguageServerSettings.fromConfiguration(this.configuration, this.user);
                return [serverSettings];
            },
        };
        this.window = {
            showDocument: async (params, next) => {
                let uri;
                try {
                    // TODO: Change this to use URI parsing instead of URL parsing.
                    uri = new URL(decodeURI(params.uri).replaceAll('\\', '/'));
                }
                catch (error) {
                    this.logger.debug('Invalid URI received for window/showDocument');
                    return (await next(params, types_1.CancellationToken.None));
                }
                // Looking for 'snyk://filePath?product=Snyk+Code&issueId=123abc456&action=showInDetailPanel'
                if (uri.protocol !== 'snyk:' || uri.searchParams.get('action') !== types_2.SnykURIAction.ShowInDetailPanel) {
                    return (await next(params, types_1.CancellationToken.None));
                }
                this.logger.debug(`Intercepted window/showDocument request (action=${types_2.SnykURIAction.ShowInDetailPanel}): ${params.uri}`);
                const product = uri.searchParams.get('product');
                if (product === null || !(0, tsUtil_1.isEnumStringValueOf)(types_2.LsScanProduct, product)) {
                    this.logger.error(`Invalid "snyk:" URI received (bad or unknown product)! ${params.uri}`);
                    return { success: false };
                }
                const issueId = uri.searchParams.get('issueId');
                if (issueId === null || issueId === '') {
                    this.logger.error(`Invalid "snyk:" URI received (bad issueId)! ${params.uri}`);
                    return { success: false };
                }
                this.showIssueDetailTopic$.next({
                    product,
                    issueId,
                });
                return { success: true };
            },
        };
    }
}
exports.LanguageClientMiddleware = LanguageClientMiddleware;
//# sourceMappingURL=middleware.js.map