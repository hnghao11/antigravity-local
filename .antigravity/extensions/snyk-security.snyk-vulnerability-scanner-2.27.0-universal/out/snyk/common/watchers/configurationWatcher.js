"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const _ = __importStar(require("lodash"));
const vscode = __importStar(require("vscode"));
const instance_1 = require("../configuration/instance");
const general_1 = require("../constants/general");
const settings_1 = require("../constants/settings");
const errorHandler_1 = require("../error/errorHandler");
const errors_1 = require("../messages/errors");
const secretStorage_1 = __importDefault(require("../vscode/secretStorage"));
const workspace_1 = require("../vscode/workspace");
const views_1 = require("../constants/views");
const securityAtInceptionHandler_1 = require("../configuration/securityAtInceptionHandler");
const languageServer_1 = require("../languageServer/languageServer");
class ConfigurationWatcher {
    constructor(logger, user, vscodeContext) {
        this.logger = logger;
        this.user = user;
        this.vscodeContext = vscodeContext;
    }
    async onChangeConfiguration(extension, key, event) {
        if (key === settings_1.ADVANCED_AUTO_SELECT_ORGANIZATION) {
            return this.syncFolderConfigAutoOrgOnChange(event);
        }
        else if (key === settings_1.ADVANCED_ORGANIZATION) {
            await this.syncFolderConfigPreferredOrgOnWorkspaceFolderOrgSettingChanged(event);
            return extension.setupFeatureFlags();
        }
        else if (key === settings_1.ADVANCED_ADVANCED_MODE_SETTING) {
            return extension.checkAdvancedMode();
        }
        else if (key === settings_1.OSS_ENABLED_SETTING) {
            extension.viewManagerService.refreshOssView();
        }
        else if (key === settings_1.CODE_SECURITY_ENABLED_SETTING) {
            return extension.viewManagerService.refreshAllCodeAnalysisViews();
        }
        else if (key === settings_1.IAC_ENABLED_SETTING) {
            return extension.viewManagerService.refreshIacView();
        }
        else if (key === settings_1.ISSUE_VIEW_OPTIONS_SETTING) {
            extension.viewManagerService.refreshAllViews();
        }
        else if (key === settings_1.SEVERITY_FILTER_SETTING) {
            return extension.viewManagerService.refreshAllViews();
        }
        else if (key === settings_1.ADVANCED_CUSTOM_ENDPOINT) {
            return instance_1.configuration.clearToken();
        }
        else if (key === settings_1.ADVANCED_AUTHENTICATION_METHOD) {
            await extension.contextService.setContext(views_1.SNYK_CONTEXT.LOGGEDIN, false);
            await extension.contextService.setContext(views_1.SNYK_CONTEXT.AUTHENTICATION_METHOD_CHANGED, true);
            return extension.viewManagerService.refreshAllViews();
        }
        else if (key === settings_1.ADVANCED_CLI_PATH) {
            // Language Server client must sync config changes before we can restart
            return _.debounce(() => extension.restartLanguageServer(), general_1.DEFAULT_LS_DEBOUNCE_INTERVAL)();
        }
        else if (key === settings_1.ADVANCED_CLI_RELEASE_CHANNEL) {
            await extension.stopLanguageServer();
            extension.initDependencyDownload();
            return;
        }
        else if (key === settings_1.FOLDER_CONFIGS || key == settings_1.DELTA_FINDINGS) {
            return extension.viewManagerService.refreshAllViews();
        }
        else if (key === settings_1.TRUSTED_FOLDERS) {
            extension.workspaceTrust.resetTrustedFoldersCache();
            extension.viewManagerService.refreshAllViews();
        }
        else if (key === settings_1.AUTO_CONFIGURE_MCP_SERVER || key === settings_1.SECURITY_AT_INCEPTION_EXECUTION_FREQUENCY) {
            return (0, securityAtInceptionHandler_1.handleSecurityAtInceptionChange)(extension, this.logger, this.user, this.vscodeContext);
        }
        // from here on only for OSS and trusted folders
        const extensionConfig = vscode.workspace.getConfiguration('snyk');
        const url = extensionConfig.get('url');
        const cleaned = url === null || url === void 0 ? void 0 : url.replace(/\/$/, '');
        if (cleaned !== url) {
            void extensionConfig.update('url', cleaned, true);
        }
        return extension.runScan();
    }
    activate(extension) {
        vscode.workspace.onDidChangeConfiguration(async (event) => {
            const change = [
                settings_1.ADVANCED_ADVANCED_MODE_SETTING,
                settings_1.ADVANCED_AUTOSCAN_OSS_SETTING,
                settings_1.ADVANCED_AUTO_SELECT_ORGANIZATION,
                settings_1.ADVANCED_ORGANIZATION,
                settings_1.OSS_ENABLED_SETTING,
                settings_1.CODE_SECURITY_ENABLED_SETTING,
                settings_1.IAC_ENABLED_SETTING,
                settings_1.SEVERITY_FILTER_SETTING,
                settings_1.ADVANCED_CUSTOM_ENDPOINT,
                settings_1.ADVANCED_CLI_PATH,
                settings_1.ADVANCED_CLI_RELEASE_CHANNEL,
                settings_1.ADVANCED_AUTHENTICATION_METHOD,
                settings_1.TRUSTED_FOLDERS,
                settings_1.ISSUE_VIEW_OPTIONS_SETTING,
                settings_1.DELTA_FINDINGS,
                settings_1.FOLDER_CONFIGS,
                settings_1.AUTO_CONFIGURE_MCP_SERVER,
                settings_1.SECURITY_AT_INCEPTION_EXECUTION_FREQUENCY,
            ].find(config => event.affectsConfiguration(config));
            if (change) {
                try {
                    await this.onChangeConfiguration(extension, change, event);
                }
                catch (error) {
                    errorHandler_1.ErrorHandler.handle(error, this.logger, `${errors_1.errorsLogs.configWatcher}. Configuration key: ${change}`);
                }
            }
        });
        secretStorage_1.default.instance.onDidChange(event => {
            if (event.key === general_1.SNYK_TOKEN_KEY) {
                return extension.runScan();
            }
        });
    }
    async syncFolderConfigAutoOrgOnChange(event) {
        const affectedWorkspaceFolders = workspace_1.vsCodeWorkspace
            .getWorkspaceFolders()
            .filter(folder => event.affectsConfiguration(settings_1.ADVANCED_AUTO_SELECT_ORGANIZATION, folder));
        if (affectedWorkspaceFolders.length === 0) {
            return;
        }
        const updatedFolderConfigs = instance_1.configuration.getFolderConfigs().map(folderConfig => {
            const workspaceFolder = affectedWorkspaceFolders.find(workspaceFolder => workspaceFolder.uri.fsPath === folderConfig.folderPath);
            if (!workspaceFolder) {
                return folderConfig;
            }
            // Get the effective value considering all levels (global, workspace, folder)
            const autoOrgEnabled = instance_1.configuration.isAutoSelectOrganizationEnabled(workspaceFolder);
            return {
                ...folderConfig,
                orgSetByUser: !autoOrgEnabled,
            };
        });
        await instance_1.configuration.setFolderConfigs(updatedFolderConfigs);
    }
    async syncFolderConfigPreferredOrgOnWorkspaceFolderOrgSettingChanged(event) {
        const affectedWorkspaceFolders = workspace_1.vsCodeWorkspace
            .getWorkspaceFolders()
            .filter(folder => event.affectsConfiguration(settings_1.ADVANCED_ORGANIZATION, folder));
        if (affectedWorkspaceFolders.length === 0) {
            return;
        }
        const updatedFolderConfigs = instance_1.configuration.getFolderConfigs().map(folderConfig => {
            const workspaceFolder = affectedWorkspaceFolders.find(workspaceFolder => workspaceFolder.uri.fsPath === folderConfig.folderPath);
            if (!workspaceFolder) {
                return folderConfig;
            }
            // Skip updates triggered by LS displaying org from folder configs
            if (languageServer_1.LanguageServer.isLSUpdatingOrg(folderConfig.folderPath)) {
                return folderConfig;
            }
            const orgValueAtFolderLevel = instance_1.configuration.getConfigurationAtFolderLevelOnly(settings_1.ADVANCED_ORGANIZATION, workspaceFolder);
            // Update preferredOrg with the new value and set orgSetByUser to true.
            return {
                ...folderConfig,
                orgSetByUser: true,
                preferredOrg: orgValueAtFolderLevel !== null && orgValueAtFolderLevel !== void 0 ? orgValueAtFolderLevel : '',
            };
        });
        await instance_1.configuration.setFolderConfigs(updatedFolderConfigs);
    }
}
exports.default = ConfigurationWatcher;
//# sourceMappingURL=configurationWatcher.js.map