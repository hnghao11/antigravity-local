"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handleSecurityAtInceptionChange = void 0;
const instance_1 = require("./instance");
const configuration_1 = require("./configuration");
const globalState_1 = require("../constants/globalState");
const AnalyticsSender_1 = require("../analytics/AnalyticsSender");
const AnalyticsEvent_1 = require("../analytics/AnalyticsEvent");
const commands_1 = require("../vscode/commands");
const mcp_1 = require("../../cli/mcp/mcp");
async function handleSecurityAtInceptionChange(extension, logger, user, vscodeContext) {
    var _a, _b;
    if (!extension.context) {
        return;
    }
    const currentAutoConfigureMcpServerConfig = instance_1.configuration.getAutoConfigureMcpServer();
    const currentSecureAtInceptionExecutionFrequencyConfig = instance_1.configuration.getSecureAtInceptionExecutionFrequency();
    const previousAutoConfigureMcpServerConfig = (_a = extension.context.getGlobalStateValue(globalState_1.MEMENTO_AUTO_CONFIGURE_MCP_SERVER)) !== null && _a !== void 0 ? _a : false;
    const previousSecureAtInceptionExecutionFrequencyConfig = (_b = extension.context.getGlobalStateValue(globalState_1.MEMENTO_SECURE_AT_INCEPTION_EXECUTION_FREQUENCY)) !== null && _b !== void 0 ? _b : configuration_1.DEFAULT_SECURE_AT_INCEPTION_EXECUTION_FREQUENCY;
    if (currentAutoConfigureMcpServerConfig !== previousAutoConfigureMcpServerConfig) {
        await extension.context.updateGlobalStateValue(globalState_1.MEMENTO_AUTO_CONFIGURE_MCP_SERVER, currentAutoConfigureMcpServerConfig);
        sendConfigChangedAnalytics(extension, logger, user, 'autoConfigureSnykMcpServer', previousAutoConfigureMcpServerConfig, currentAutoConfigureMcpServerConfig);
    }
    if (currentSecureAtInceptionExecutionFrequencyConfig !== previousSecureAtInceptionExecutionFrequencyConfig) {
        await extension.context.updateGlobalStateValue(globalState_1.MEMENTO_SECURE_AT_INCEPTION_EXECUTION_FREQUENCY, currentSecureAtInceptionExecutionFrequencyConfig);
        sendConfigChangedAnalytics(extension, logger, user, 'secureAtInceptionExecutionFrequency', previousSecureAtInceptionExecutionFrequencyConfig, currentSecureAtInceptionExecutionFrequencyConfig);
    }
    await (0, mcp_1.configureMcpHosts)(vscodeContext, instance_1.configuration);
}
exports.handleSecurityAtInceptionChange = handleSecurityAtInceptionChange;
function sendConfigChangedAnalytics(extension, logger, user, field, oldValue, newValue) {
    const analyticsSender = AnalyticsSender_1.AnalyticsSender.getInstance(logger, instance_1.configuration, commands_1.vsCodeCommands, extension.contextService);
    const event = new AnalyticsEvent_1.AnalyticsEvent(user.anonymousId, 'Config changed', []);
    event.getExtension().set(`config::${field}::oldValue`, oldValue);
    event.getExtension().set(`config::${field}::newValue`, newValue);
    analyticsSender.logEvent(event, () => {
        logger.info(`Analytics event sent for config change: securityAtInception.${field}`);
    });
}
//# sourceMappingURL=securityAtInceptionHandler.js.map