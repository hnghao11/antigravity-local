"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _a, _b, _c, _d, _e, _f, _g, _h;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CliExecutable = void 0;
const path_1 = __importDefault(require("path"));
const promises_1 = __importDefault(require("fs/promises"));
const platform_1 = require("../common/platform");
class CliExecutable {
    constructor(version, checksum) {
        this.version = version;
        this.checksum = checksum;
    }
    static async getPath(customPath) {
        if (customPath) {
            return customPath;
        }
        const platform = await CliExecutable.getCurrentWithArch();
        const homeDir = platform_1.Platform.getHomeDir();
        const defaultPath = this.defaultPaths[platform];
        const fileName = CliExecutable.getFileName(platform);
        const cliDir = path_1.default.join(homeDir, defaultPath, 'snyk', 'vscode-cli');
        return path_1.default.join(cliDir, fileName);
    }
    static getFileName(platform) {
        return this.filenameSuffixes[platform];
    }
    static async getCurrentWithArch() {
        const osName = platform_1.Platform.getCurrent().toString().toLowerCase();
        const archSuffix = platform_1.Platform.getArch().toLowerCase();
        const platform = await CliExecutable.getPlatformName(osName);
        let cliName = platform;
        if (archSuffix === 'arm64') {
            cliName = `${platform}_${archSuffix}`;
        }
        return cliName;
    }
    static async getPlatformName(osName) {
        let platform = '';
        if (osName === 'linux') {
            if (await CliExecutable.isAlpine()) {
                platform = 'linux_alpine';
            }
            else {
                platform = 'linux';
            }
        }
        else if (osName === 'darwin') {
            platform = 'macos';
        }
        else if (osName === 'win32') {
            platform = 'windows';
        }
        if (!platform) {
            throw new Error(`${osName} is unsupported.`);
        }
        return platform;
    }
    static isPathInExtensionDirectory(dirPath, filePath) {
        const normalizedDir = path_1.default.resolve(dirPath) + path_1.default.sep;
        const normalizedFile = path_1.default.resolve(filePath);
        return normalizedFile.toLowerCase().startsWith(normalizedDir.toLowerCase());
    }
    static async exists(customPath) {
        return promises_1.default
            .access(await CliExecutable.getPath(customPath))
            .then(() => true)
            .catch(() => false);
    }
    static async isAlpine() {
        try {
            await promises_1.default.access('/etc/alpine-release');
            return true;
        }
        catch (e) {
            return false;
        }
    }
}
exports.CliExecutable = CliExecutable;
CliExecutable.defaultPaths = {
    linux: (_a = process.env.XDG_DATA_HOME) !== null && _a !== void 0 ? _a : '/.local/share/',
    // eslint-disable-next-line camelcase
    linux_arm64: (_b = process.env.XDG_DATA_HOME) !== null && _b !== void 0 ? _b : '/.local/share/',
    // eslint-disable-next-line camelcase
    linux_alpine: (_c = process.env.XDG_DATA_HOME) !== null && _c !== void 0 ? _c : '/.local/share/',
    // eslint-disable-next-line camelcase
    linux_alpine_arm64: (_d = process.env.XDG_DATA_HOME) !== null && _d !== void 0 ? _d : '/.local/share/',
    macos: (_e = process.env.XDG_DATA_HOME) !== null && _e !== void 0 ? _e : '/Library/Application Support/',
    // eslint-disable-next-line camelcase
    macos_arm64: (_f = process.env.XDG_DATA_HOME) !== null && _f !== void 0 ? _f : '/Library/Application Support/',
    windows: (_g = process.env.XDG_DATA_HOME) !== null && _g !== void 0 ? _g : '\\AppData\\Local\\',
    // eslint-disable-next-line camelcase
    windows_arm64: (_h = process.env.XDG_DATA_HOME) !== null && _h !== void 0 ? _h : '\\AppData\\Local\\',
};
CliExecutable.filenameSuffixes = {
    linux: 'snyk-linux',
    // eslint-disable-next-line camelcase
    linux_arm64: 'snyk-linux-arm64',
    // eslint-disable-next-line camelcase
    linux_alpine: 'snyk-alpine',
    // eslint-disable-next-line camelcase
    linux_alpine_arm64: 'snyk-alpine-arm64',
    macos: 'snyk-macos',
    // eslint-disable-next-line camelcase
    macos_arm64: 'snyk-macos-arm64',
    windows: 'snyk-win.exe',
    // eslint-disable-next-line camelcase
    windows_arm64: 'snyk-win.exe',
};
//# sourceMappingURL=cliExecutable.js.map